name: Release APK

on:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write

jobs:
    release-apk:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Set up JDK 17
              uses: actions/setup-java@v5
              with:
                  distribution: temurin
                  java-version: 17

            - name: Setup Gradle
              uses: gradle/actions/setup-gradle@v5

            - name: Decode release keystore
              run: |
                  echo "${{ secrets.LAZYPIZZA_KEYSTORE_BASE64 }}" | base64 --decode > "${{ github.workspace }}/release.keystore"

            - name: Assemble Release APK
              env:
                  LAZYPIZZA_STORE_FILE: ${{ github.workspace }}/release.keystore
                  LAZYPIZZA_STORE_PASSWORD: ${{ secrets.LAZYPIZZA_STORE_PASSWORD }}
                  LAZYPIZZA_KEY_ALIAS: ${{ secrets.LAZYPIZZA_KEY_ALIAS }}
                  LAZYPIZZA_KEY_PASSWORD: ${{ secrets.LAZYPIZZA_KEY_PASSWORD }}
              run: ./gradlew --no-daemon :app:assembleRelease

            - name: Rename APK with version
              run: |
                  VERSION="${GITHUB_REF_NAME}"
                  mv app/build/outputs/apk/release/app-release.apk "app/build/outputs/apk/release/lazy-pizza-${VERSION}.apk"

            - name: Publish GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: app/build/outputs/apk/release/lazy-pizza-${{ github.ref_name }}.apk
                  generate_release_notes: true
